<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë†ì‚°ë¬¼ ê°€ê²© ë¶„ì„ ì±—ë´‡</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            /* âœ… ê°€ë¡œ íŠ ë°©ì§€ */
        }

        .container {
            display: flex;
            height: 100vh;
            padding: 20px;
            gap: 20px;
            min-width: 0;
            /* âœ… flex ìì‹ overflow ë°©ì§€ */
        }

        /* ì™¼ìª½: ëŒ€ì‹œë³´ë“œ */
        .dashboard {
            flex: 1.5;
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
            /* âœ… grid/plotly overflow ë°©ì§€ */
        }

        .dashboard-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f0f0f0;
        }

        .dashboard-header h1 {
            font-size: 24px;
            color: #333;
        }

        .dashboard-header .icon {
            font-size: 32px;
        }

        /* ë©”íŠ¸ë¦­ ì¹´ë“œ */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #1f77b4;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 13px;
            color: #666;
        }

        .metric-delta {
            font-size: 12px;
            margin-top: 4px;
        }

        .metric-delta.positive {
            color: #28a745;
        }

        .metric-delta.negative {
            color: #dc3545;
        }

        /* ì°¨íŠ¸ ì˜ì—­ */
        .charts-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
            min-height: 0;
            /* âœ… scroll containerì—ì„œ ë‚´ë¶€ ë†’ì´ ê³„ì‚° ì•ˆì •í™” */
            padding-right: 4px;
        }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            align-items: stretch;
            min-width: 0;
            /* âœ… grid overflow ë°©ì§€ */
        }

        .chart-box {
            background: #fafafa;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #eee;

            /* âœ… Plotlyê°€ ë¶€ëª¨ ë°•ìŠ¤ ê¸°ì¤€ìœ¼ë¡œ ì¡íˆê²Œ */
            position: relative;
            overflow: hidden;
            min-width: 0;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: #444;
            margin-bottom: 12px;
        }

        /* âœ… placeholder ìƒíƒœ: flexë¡œ í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ */
        .chart-placeholder {
            height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
        }

        /* âœ… forecast placeholderëŠ” ë” ë†’ê²Œ */
        #forecast-chart.chart-placeholder {
            height: 360px;
        }

        /* âœ… ì°¨íŠ¸ê°€ ê·¸ë ¤ì§€ë©´ placeholder í•´ì œ â†’ blockìœ¼ë¡œ ì „í™˜ */
        .chart-area {
            height: 280px;
            width: 100%;
            display: block;  /* flex í•´ì œ í•„ìˆ˜! */
        }

        #forecast-chart.chart-area {
            height: 360px;
        }

        /* âœ… Plotly ë‚´ë¶€ SVGê°€ ë¶€ëª¨ë¥¼ ë„˜ì§€ ì•Šë„ë¡ */
        .chart-area .plotly,
        .chart-area .js-plotly-plot {
            width: 100% !important;
            max-width: 100%;
        }

        /* ë‚´ëŸ¬í‹°ë¸Œ */
        .narrative-box {
            background: linear-gradient(135deg, #e8f4fd 0%, #d4e8f7 100%);
            border-radius: 12px;
            padding: 16px;
            margin-top: auto;
            max-height: 150px;
            overflow-y: auto;
        }

        .narrative-title {
            font-size: 14px;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 8px;
        }

        .narrative-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }

        /* ì˜¤ë¥¸ìª½: ì±„íŒ… */
        .chat-panel {
            flex: 1;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
            /* âœ… flex overflow ë°©ì§€ */
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-header h2 {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .chat-header p {
            font-size: 13px;
            opacity: 0.9;
        }

        /* ì˜ˆì‹œ ì§ˆë¬¸ */
        .example-questions {
            padding: 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .example-questions h4 {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .example-btn {
            display: block;
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: left;
            font-size: 13px;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
        }

        .example-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .example-btn:last-child {
            margin-bottom: 0;
        }

        /* ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ */
        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
            word-break: break-word;
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.bot {
            align-self: flex-start;
            background: #f0f0f0;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .message.error {
            background: #ffebee;
            color: #c62828;
        }

        .message.loading {
            background: #e3f2fd;
            color: #1565c0;
        }

        /* ì…ë ¥ ì˜ì—­ */
        .chat-input-container {
            padding: 16px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #ddd;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-btn {
            padding: 14px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .send-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Clarification UI */
        .clarify-container {
            background: #fff8e1;
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
        }

        .clarify-question {
            font-size: 14px;
            font-weight: 600;
            color: #f57c00;
            margin-bottom: 12px;
        }

        .clarify-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .clarify-option {
            padding: 10px 14px;
            background: white;
            border: 1px solid #ffcc80;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .clarify-option:hover {
            background: #ff9800;
            color: white;
            border-color: #ff9800;
        }

        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* ì˜ˆì¸¡ í…Œì´ë¸” */
        .forecast-summary {
            background: #fafafa;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #eee;
        }

        .forecast-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .forecast-table th,
        .forecast-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .forecast-table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #444;
        }

        .forecast-table tr:hover {
            background: #f9f9f9;
        }

        .change-up {
            color: #28a745;
            font-weight: 600;
        }

        .change-down {
            color: #dc3545;
            font-weight: 600;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
            }

            .dashboard,
            .chat-panel {
                flex: none;
                height: 50vh;
                min-height: 400px;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .chart-row {
                grid-template-columns: 1fr;
            }

            /* âœ… 1ì—´ ì „í™˜ ì‹œ span 2 ë¬´íš¨í™” */
            .chart-box {
                grid-column: span 1 !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ì™¼ìª½: ëŒ€ì‹œë³´ë“œ -->
        <div class="dashboard">
            <div class="dashboard-header">
                <span class="icon">ğŸŒ¾</span>
                <h1>ë†ì‚°ë¬¼ ê°€ê²© ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
                <span id="today-date" style="margin-left: auto; font-size: 14px; color: #666;"></span>
            </div>

            <!-- ë©”íŠ¸ë¦­ ì¹´ë“œ -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="metric-price">-</div>
                    <div class="metric-label">ìµœê·¼ ê°€ê²© (ì›/kg)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-volume">-</div>
                    <div class="metric-label">ìµœê·¼ ë°˜ì…ëŸ‰ (kg)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-wow">-</div>
                    <div class="metric-label">ì „ì£¼ ëŒ€ë¹„</div>
                    <div class="metric-delta" id="metric-wow-delta"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metric-volatility">-</div>
                    <div class="metric-label">ë³€ë™ì„± (14ì¼)</div>
                </div>
            </div>

            <!-- ì°¨íŠ¸ ì˜ì—­ -->
            <div class="charts-container">
                <div class="chart-row">
                    <div class="chart-box">
                        <div class="chart-title">ğŸ“ˆ ê°€ê²© ì¶”ì„¸</div>
                        <div id="price-chart" class="chart-placeholder">ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´ ì°¨íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
                    </div>
                    <div class="chart-box">
                        <div class="chart-title">ğŸ“Š ë°˜ì…ëŸ‰</div>
                        <div id="volume-chart" class="chart-placeholder">ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´ ì°¨íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
                    </div>
                </div>

                <!-- ì˜ˆì¸¡ ì°¨íŠ¸ ì„¹ì…˜ -->
                <div class="chart-row" id="forecast-section">
                    <div class="chart-box" style="grid-column: span 2;">
                        <div class="chart-title">ğŸ”® 3ê°œì›” ê°€ê²© ì˜ˆì¸¡ </div>
                        <div id="forecast-chart" class="chart-placeholder">ì˜ˆì¸¡ ë°ì´í„° ë¡œë”© ì¤‘...</div>
                    </div>
                </div>

                <!-- ì˜ˆì¸¡ ìš”ì•½ í…Œì´ë¸” -->
                <div class="forecast-summary" id="forecast-summary" style="display: none;">
                    <div class="chart-title">ğŸ“‹ í’ˆëª©ë³„ ì˜ˆì¸¡ ìš”ì•½</div>
                    <table class="forecast-table" id="forecast-table">
                        <thead>
                            <tr>
                                <th>í’ˆëª©</th>
                                <th>í˜„ì¬ê°€</th>
                                <th>3ê°œì›” í›„ ì˜ˆì¸¡</th>
                                <th>ë³€í™”ìœ¨</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- ë‚´ëŸ¬í‹°ë¸Œ -->
            <div class="narrative-box" id="narrative-box" style="display: none;">
                <div class="narrative-title">ğŸ“ ë¶„ì„ ì„¤ëª…</div>
                <div class="narrative-content" id="narrative-content"></div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì±„íŒ… -->
        <div class="chat-panel">
            <div class="chat-header">
                <h2>ğŸ¤– AI ë¶„ì„ ì–´ì‹œìŠ¤í„´íŠ¸</h2>
                <p>ìì—°ì–´ë¡œ ì§ˆë¬¸í•˜ì„¸ìš”</p>
            </div>

            <!-- ì˜ˆì‹œ ì§ˆë¬¸ -->
            <div class="example-questions">
                <h4>ğŸ’¡ ì˜ˆì‹œ ì§ˆë¬¸</h4>
                <button class="example-btn" onclick="sendExample(this.textContent)">ê°ì ìˆ˜ë¯¸, ìµœê·¼ 6ê°œì›” ê°€ê²© ì¶”ì„¸ ë³´ì—¬ì¤˜</button>
                <button class="example-btn" onclick="sendExample(this.textContent)">ì–‘íŒŒ, 2019ë…„ ê°€ê²©ê³¼ ë°˜ì…ëŸ‰ ê°™ì´ ë³´ì—¬ì¤˜</button>
                <button class="example-btn" onclick="sendExample(this.textContent)">ë°°ì¶”, ìµœê·¼ 3ê°œì›” ë³€ë™ì„± í° êµ¬ê°„ ì•Œë ¤ì¤˜</button>
                <button class="example-btn" onclick="sendExample(this.textContent)">ë§ˆëŠ˜, ì‹œì¥ë³„ ë¹„êµí•´ì¤˜</button>
            </div>

            <!-- ì±„íŒ… ë©”ì‹œì§€ -->
            <div class="chat-messages" id="chat-messages">
                <div class="message bot">
                    ì•ˆë…•í•˜ì„¸ìš”! ë†ì‚°ë¬¼ ê°€ê²© ë¶„ì„ ì±—ë´‡ì…ë‹ˆë‹¤. ğŸŒ¾<br><br>
                    ê¶ê¸ˆí•œ í’ˆëª©ì˜ ê°€ê²©, ì¶”ì„¸, ë³€ë™ì„± ë“±ì„ ìì—°ì–´ë¡œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.
                </div>
            </div>

            <!-- ì…ë ¥ -->
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="chat-input" placeholder="ì˜ˆ: ê°ì ìˆ˜ë¯¸, ìµœê·¼ 6ê°œì›” ê°€ê²© ì¶”ì„¸ ë³´ì—¬ì¤˜"
                        onkeypress="handleKeyPress(event)">
                    <button class="send-btn" id="send-btn" onclick="sendMessage()">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •
        const API_ENDPOINT = window.API_ENDPOINT || '/api/query';

        let currentQuestion = '';
        let isLoading = false;
        let currentItemName = null;  // í˜„ì¬ ì¡°íšŒ ì¤‘ì¸ í’ˆëª©ëª… (ì˜ˆì¸¡ ì°¨íŠ¸ í•˜ì´ë¼ì´íŠ¸ìš©)

        // âœ… plotly resize helper (ì°¨íŠ¸ê°€ ì»¨í…Œì´ë„ˆ ë°–ìœ¼ë¡œ íŠ€ëŠ” í˜„ìƒ ë°©ì§€)
        function safeResize(divId) {
            const el = document.getElementById(divId);
            if (!el) return;
            // Plotlyê°€ ë¶™ì–´ìˆì„ ë•Œë§Œ resize
            if (el.classList.contains('js-plotly-plot')) {
                Plotly.Plots.resize(el);
            }
        }

        function resizeAllCharts() {
            safeResize('price-chart');
            safeResize('volume-chart');
            safeResize('forecast-chart');
        }

        window.addEventListener('resize', () => {
            // ë¸Œë¼ìš°ì € ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì¬ê³„ì‚°
            resizeAllCharts();
        });

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const question = input.value.trim();

            if (!question || isLoading) return;

            currentQuestion = question;
            input.value = '';

            addMessage(question, 'user');
            showLoading();

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });

                const data = await response.json();
                hideLoading();
                handleResponse(data);

            } catch (error) {
                hideLoading();
                addMessage('ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'bot error');
                console.error('API Error:', error);
            }
        }

        // ì˜ˆì‹œ ì§ˆë¬¸ ì „ì†¡
        function sendExample(text) {
            document.getElementById('chat-input').value = text;
            sendMessage();
        }

        // ì‘ë‹µ ì²˜ë¦¬
        function handleResponse(data) {
            if (data.error) {
                addMessage(`ì˜¤ë¥˜: ${data.error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'bot error');
                return;
            }

            if (data.type === 'clarify') {
                showClarification(data.clarification);
                return;
            }

            const filters = data.filters || {};
            const series = data.series || [];
            const summary = data.summary || {};
            const narrative = data.narrative || '';

            // í˜„ì¬ ì¡°íšŒ í’ˆëª© ì €ì¥ (ì˜ˆì¸¡ ì°¨íŠ¸ í•˜ì´ë¼ì´íŠ¸ìš©)
            if (filters.item_name) {
                currentItemName = filters.item_name;
                // ì˜ˆì¸¡ ì°¨íŠ¸ ë‹¤ì‹œ ë Œë”ë§ (í•˜ì´ë¼ì´íŠ¸ ì ìš©)
                if (forecastData) {
                    renderForecastChart(forecastData, currentItemName);
                }
            }

            updateMetrics(summary);

            if (series.length > 0) {
                renderPriceChart(series, filters);
                renderVolumeChart(series, filters);
            }

            if (narrative) {
                showNarrative(narrative);
                addMessage(narrative, 'bot');
            } else {
                addMessage(`${filters.item_name || 'í’ˆëª©'} ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì™¼ìª½ ëŒ€ì‹œë³´ë“œì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.`, 'bot');
            }

            if (data.warnings && data.warnings.length > 0) {
                data.warnings.forEach(w => {
                    if (w && w.trim()) addMessage(`âš ï¸ ${w}`, 'bot');
                });
            }

            // âœ… ë Œë” ì§í›„ í•œ ë²ˆ ë” resize (scroll containerì—ì„œ íŠ¹íˆ ì¤‘ìš”)
            setTimeout(resizeAllCharts, 50);
        }

        // Clarification UI
        function showClarification(clarification) {
            const questions = clarification.questions || [];
            if (questions.length === 0) return;

            const messagesDiv = document.getElementById('chat-messages');

            questions.forEach(q => {
                const container = document.createElement('div');
                container.className = 'clarify-container';
                container.innerHTML = `
                <div class="clarify-question">${q.question}</div>
                <div class="clarify-options">
                    ${q.options.map(opt => `
                        <div class="clarify-option" onclick="answerClarify('${q.id}', '${opt}')">${formatOption(opt)}</div>
                    `).join('')}
                </div>
            `;
                messagesDiv.appendChild(container);
            });

            scrollToBottom();
        }

        function formatOption(opt) {
            const labels = {
                'high_avg_price': 'í‰ê· ê°€ê²©ì´ ë†’ì€',
                'high_price_change': 'ê°€ê²© ìƒìŠ¹ë¥ ì´ í°',
                'high_volatility': 'ë³€ë™ì„±ì´ í°',
                '30d': 'ìµœê·¼ 30ì¼',
                '90d': 'ìµœê·¼ 90ì¼',
                '180d': 'ìµœê·¼ 6ê°œì›”'
            };
            return labels[opt] || opt;
        }

        async function answerClarify(id, answer) {
            showLoading();

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: currentQuestion,
                        clarify_answers: { [id]: answer }
                    })
                });

                const data = await response.json();
                hideLoading();
                handleResponse(data);

            } catch (error) {
                hideLoading();
                addMessage('ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'bot error');
            }
        }

        // ë©”íŠ¸ë¦­ ì—…ë°ì´íŠ¸
        function updateMetrics(summary) {
            const priceEl = document.getElementById('metric-price');
            const volumeEl = document.getElementById('metric-volume');
            const wowEl = document.getElementById('metric-wow');
            const wowDeltaEl = document.getElementById('metric-wow-delta');
            const volatilityEl = document.getElementById('metric-volatility');

            if (summary.latest_price) priceEl.textContent = Number(summary.latest_price).toLocaleString();
            if (summary.latest_volume) volumeEl.textContent = Number(summary.latest_volume).toLocaleString();

            if (summary.wow_price_pct !== undefined && summary.wow_price_pct !== null) {
                const pct = summary.wow_price_pct;
                wowEl.textContent = `${pct >= 0 ? '+' : ''}${pct.toFixed(1)}%`;
                wowDeltaEl.textContent = pct >= 0 ? 'â–² ìƒìŠ¹' : 'â–¼ í•˜ë½';
                wowDeltaEl.className = `metric-delta ${pct >= 0 ? 'positive' : 'negative'}`;
            }

            if (summary.volatility_14d) volatilityEl.textContent = Number(summary.volatility_14d).toFixed(0);
        }

        // âœ… ì°¨íŠ¸ div ì¤€ë¹„: placeholder â†’ chart-area í´ë˜ìŠ¤ êµì²´
        function prepareChartDiv(divId) {
            const el = document.getElementById(divId);
            if (!el) return null;
            el.innerHTML = '';
            el.classList.remove('chart-placeholder');
            el.classList.add('chart-area');
            return el;
        }

        // ê°€ê²© ì°¨íŠ¸
        function renderPriceChart(series, filters) {
            const chartDiv = prepareChartDiv('price-chart');
            if (!chartDiv) return;

            const dates = series.map(s => s.date);
            const prices = series.map(s => s.price);

            const trace = {
                x: dates,
                y: prices,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'ê°€ê²©',
                marker: { size: 4 }
            };

            const layout = {
                autosize: true,
                margin: { t: 10, r: 20, b: 40, l: 60 },
                xaxis: { title: '' },
                yaxis: { title: 'ì›/kg' },
                hovermode: 'x unified',
                showlegend: false
            };

            Plotly.newPlot(chartDiv, [trace], layout, { responsive: true, displayModeBar: false })
                .then(() => setTimeout(() => safeResize('price-chart'), 30));
        }

        // ë°˜ì…ëŸ‰ ì°¨íŠ¸
        function renderVolumeChart(series, filters) {
            const chartDiv = prepareChartDiv('volume-chart');
            if (!chartDiv) return;

            const dates = series.map(s => s.date);
            const volumes = series.map(s => s.volume);

            const trace = {
                x: dates,
                y: volumes,
                type: 'bar',
                name: 'ë°˜ì…ëŸ‰'
            };

            const layout = {
                autosize: true,
                margin: { t: 10, r: 20, b: 40, l: 60 },
                xaxis: { title: '' },
                yaxis: { title: 'kg' },
                hovermode: 'x unified',
                showlegend: false
            };

            Plotly.newPlot(chartDiv, [trace], layout, { responsive: true, displayModeBar: false })
                .then(() => setTimeout(() => safeResize('volume-chart'), 30));
        }

        // ë‚´ëŸ¬í‹°ë¸Œ í‘œì‹œ
        function showNarrative(text) {
            const box = document.getElementById('narrative-box');
            const content = document.getElementById('narrative-content');
            content.textContent = text;
            box.style.display = 'block';
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(text, type) {
            const messagesDiv = document.getElementById('chat-messages');
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.innerHTML = text.replace(/\n/g, '<br>');
            messagesDiv.appendChild(msg);
            scrollToBottom();
        }

        // ë¡œë”© í‘œì‹œ
        function showLoading() {
            isLoading = true;
            document.getElementById('send-btn').disabled = true;

            const messagesDiv = document.getElementById('chat-messages');
            const loading = document.createElement('div');
            loading.id = 'loading-msg';
            loading.className = 'message bot loading';
            loading.innerHTML = `
            <div class="typing-indicator">
                <span></span><span></span><span></span>
            </div>
            ë¶„ì„ ì¤‘...
        `;
            messagesDiv.appendChild(loading);
            scrollToBottom();
        }

        function hideLoading() {
            isLoading = false;
            document.getElementById('send-btn').disabled = false;
            const loading = document.getElementById('loading-msg');
            if (loading) loading.remove();
        }

        function scrollToBottom() {
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        // ========================================
        // ì˜ˆì¸¡ ë°ì´í„° ê´€ë ¨ í•¨ìˆ˜
        // ========================================
        let forecastData = null;

        async function loadForecastData() {
            try {
                const forecastEndpoint = API_ENDPOINT.replace('/query', '/forecast');
                const response = await fetch(forecastEndpoint);
                const data = await response.json();

                if (data.type === 'forecast' && data.data) {
                    forecastData = data.data;
                    renderForecastChart(forecastData);
                    renderForecastTable(forecastData);
                    setTimeout(resizeAllCharts, 50);
                }
            } catch (error) {
                console.error('Forecast data load error:', error);
                const el = document.getElementById('forecast-chart');
                el.textContent = 'ì˜ˆì¸¡ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
        }

        function renderForecastChart(data, highlightItem = null) {
            const chartDiv = prepareChartDiv('forecast-chart');
            if (!chartDiv) return;

            const traces = [];
            const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
                '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'];

            // í•˜ì´ë¼ì´íŠ¸ í’ˆëª©ì´ ìˆìœ¼ë©´ í•´ë‹¹ í’ˆëª©ì„ ë¨¼ì € ê·¸ë¦¬ê³ , ë‚˜ë¨¸ì§€ëŠ” íë¦¬ê²Œ
            const hasHighlight = highlightItem && data.some(d => d.item_name === highlightItem);

            data.forEach((item, idx) => {
                const dates = item.forecasts.map(f => f.date);
                const prices = item.forecasts.map(f => f.price);

                const isHighlighted = hasHighlight && item.item_name === highlightItem;
                const opacity = hasHighlight ? (isHighlighted ? 1.0 : 0.2) : 1.0;
                const lineWidth = isHighlighted ? 4 : 2;
                const markerSize = isHighlighted ? 10 : 6;

                traces.push({
                    x: dates,
                    y: prices,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: item.item_name + (isHighlighted ? ' â˜…' : ''),
                    line: {
                        width: lineWidth,
                        dash: isHighlighted ? 'solid' : 'dot',
                        color: colors[idx % colors.length]
                    },
                    marker: { size: markerSize, color: colors[idx % colors.length] },
                    opacity: opacity
                });
            });

            // í•˜ì´ë¼ì´íŠ¸ëœ í’ˆëª©ì„ ë§¨ ìœ„ë¡œ (ë§ˆì§€ë§‰ì— ê·¸ë ¤ì§€ë„ë¡)
            if (hasHighlight) {
                traces.sort((a, b) => {
                    const aHigh = a.name.includes('â˜…') ? 1 : 0;
                    const bHigh = b.name.includes('â˜…') ? 1 : 0;
                    return aHigh - bHigh;
                });
            }

            const layout = {
                autosize: true,
                margin: { t: 20, r: 20, b: 50, l: 70 },
                xaxis: { title: 'ë‚ ì§œ' },
                yaxis: { title: 'ê°€ê²© (ì›/kg)' },
                legend: {
                    orientation: 'h',
                    x: 0.5,
                    xanchor: 'center',
                    y: 1.05
                },
                hovermode: 'x unified',
                title: hasHighlight ? { text: `ğŸ“Œ ${highlightItem} ê°€ê²© ì˜ˆì¸¡`, font: { size: 14 } } : null
            };

            Plotly.newPlot(chartDiv, traces, layout, { responsive: true, displayModeBar: false })
                .then(() => setTimeout(() => safeResize('forecast-chart'), 30));
        }

        function renderForecastTable(data) {
            const tableBody = document.querySelector('#forecast-table tbody');
            tableBody.innerHTML = '';

            const sorted = [...data].sort((a, b) => b.change_pct - a.change_pct);

            sorted.forEach(item => {
                const row = document.createElement('tr');
                const changeClass = item.change_pct >= 0 ? 'change-up' : 'change-down';
                const arrow = item.change_pct >= 0 ? 'â†‘' : 'â†“';

                row.innerHTML = `
                <td><strong>${item.item_name}</strong></td>
                <td>${Number(item.last_actual_price).toLocaleString()} ì›</td>
                <td>${Number(item.predicted_price_3m).toLocaleString()} ì›</td>
                <td class="${changeClass}">${arrow} ${Math.abs(item.change_pct)}%</td>
            `;
                tableBody.appendChild(row);
            });

            document.getElementById('forecast-summary').style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function () {
            // ë°ì´í„° ê¸°ì¤€ì¼ í‘œì‹œ (CSV ìµœì‹  ë‚ ì§œ: 2021ë…„ 12ì›” í•˜ìˆœ)
            document.getElementById('today-date').textContent = 'ë°ì´í„° ê¸°ì¤€: 2021ë…„ 12ì›” í•˜ìˆœ';

            loadForecastData();
            // âœ… ì´ˆê¸° ë¡œë“œ ì‹œì—ë„ í•œ ë²ˆ ë¦¬ì‚¬ì´ì¦ˆ
            setTimeout(resizeAllCharts, 200);
        });
    </script>
</body>

</html>